name: Build-Test-Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3

    # 1ï¸âƒ£  Java build (planner.jar)
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 17

    - name: ğŸ—ï¸  Build Planner.jar
      run: |
        cd agent/java
        mvn -B package
        cp target/planner-*-jar-with-dependencies.jar ../planner.jar
        cd ../../

    # 2ï¸âƒ£  C++ build (libvector.so)
    - name: âš™ï¸  Compile C++ vector library
      run: |
        g++ -O3 -shared -std=c++17 -fPIC agent/cpp/vector.cpp -o agent/cpp/libvector.so

    # 3ï¸âƒ£  Python setup + tests
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: ğŸ“¦ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install coverage pytest jpype1 duckduckgo-search boto3 langgraph

    - name: ğŸ§ª Run tests with coverage
      run: |
        coverage run -m pytest
        coverage xml -o coverage.xml

    # 4ï¸âƒ£  Upload coverage to Codecov
    - name: ğŸ“ˆ Upload to Codecov
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: coverage.xml
        verbose: true
